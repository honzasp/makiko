<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/makiko/assets/css/just-the-docs-default.css"> <script src="/makiko/assets/js/vendor/lunr.min.js"></script> <script src="/makiko/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/makiko/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Execute a command | Makiko</title> <meta name="generator" content="Jekyll v4.3.0" /> <meta property="og:title" content="Execute a command" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Makiko is an asynchronous SSH client library in pure Rust" /> <meta property="og:description" content="Makiko is an asynchronous SSH client library in pure Rust" /> <link rel="canonical" href="https://honzasp.github.io/makiko/makiko/tutorial/5-execute-command.html" /> <meta property="og:url" content="https://honzasp.github.io/makiko/makiko/tutorial/5-execute-command.html" /> <meta property="og:site_name" content="Makiko" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Execute a command" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Makiko is an asynchronous SSH client library in pure Rust","headline":"Execute a command","url":"https://honzasp.github.io/makiko/makiko/tutorial/5-execute-command.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Feather. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/makiko/" class="site-title lh-tight"> Makiko </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/makiko/" class="nav-list-link">Home</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Tutorial category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/makiko/tutorial/" class="nav-list-link">Tutorial</a><ul class="nav-list "><li class="nav-list-item "><a href="/makiko/tutorial/1-connect.html" class="nav-list-link">Connecting to the server</a></li><li class="nav-list-item "><a href="/makiko/tutorial/2-password-auth.html" class="nav-list-link">Password authentication</a></li><li class="nav-list-item "><a href="/makiko/tutorial/3-pubkey-auth.html" class="nav-list-link">Public key authentication</a></li><li class="nav-list-item "><a href="/makiko/tutorial/4-pubkey-algo.html" class="nav-list-link">Public key algorithm</a></li><li class="nav-list-item active"><a href="/makiko/tutorial/5-execute-command.html" class="nav-list-link active">Execute a command</a></li><li class="nav-list-item "><a href="/makiko/tutorial/6-open-tunnel.html" class="nav-list-link">Open a tunnel</a></li><li class="nav-list-item "><a href="/makiko/tutorial/7-verify-pubkey.html" class="nav-list-link">Verify the server key</a></li></ul></li></ul> <ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/honzasp/makiko" class="nav-list-link external"> Makiko on Github <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li><li class="nav-list-item external"> <a href="https://docs.rs/makiko/latest/makiko" class="nav-list-link external"> API documentation <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Makiko" aria-label="Search Makiko" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/honzasp/makiko" class="site-button" > Github </a> </li> <li class="aux-nav-list-item"> <a href="https://docs.rs/makiko/latest/makiko" class="site-button" > API docs </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/makiko/tutorial/">Tutorial</a></li> <li class="breadcrumb-nav-list-item"><span>Execute a command</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="execute-a-command"> <a href="#execute-a-command" class="anchor-heading" aria-labelledby="execute-a-command"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Execute a command </h1> <p>In the previous chapters, we connected to the server and authenticated ourselves, so now we can finally execute some commands!</p> <h2 id="session"> <a href="#session" class="anchor-heading" aria-labelledby="session"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Session </h2> <p>A single SSH connection can host multiple logical channels of communication. The SSH protocol defines two kinds of channels: interactive <em>sessions</em> and TCP/IP forwarding channels (or <em>tunnels</em>). In this chapter, we will learn how to use sessions to execute commands, and the next chapter will be about tunnels.</p> <p>One session corresponds to one process: you open a session, prepare the execution environment (such as environment variables), start the command or shell, and then interact with it.</p> <h2 id="open-a-session"> <a href="#open-a-session" class="anchor-heading" aria-labelledby="open-a-session"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Open a session </h2> <p>To open a session, we use the method <a href="https://docs.rs/makiko/latest/makiko/struct.Client.html#method.open_session"><code class="language-plaintext highlighter-rouge">Client::open_session()</code></a> (after we have authenticated successfully). To configure the underlying channel, this method needs a <a href="https://docs.rs/makiko/latest/makiko/struct.ChannelConfig.html"><code class="language-plaintext highlighter-rouge">ChannelConfig</code></a>. You can adjust the configuration if you need to optimize the SSH flow control, but the default instance should work well for most use cases:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Open a session on the server.</span>
<span class="k">let</span> <span class="n">channel_config</span> <span class="o">=</span> <span class="nn">makiko</span><span class="p">::</span><span class="nn">ChannelConfig</span><span class="p">::</span><span class="nf">default</span><span class="p">();</span>
<span class="k">let</span> <span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="k">mut</span> <span class="n">session_rx</span><span class="p">)</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.open_session</span><span class="p">(</span><span class="n">channel_config</span><span class="p">)</span><span class="k">.await</span>
    <span class="nf">.expect</span><span class="p">(</span><span class="s">"Could not open a session"</span><span class="p">);</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">open_session()</code> method returns two objects, a <a href="https://docs.rs/makiko/latest/makiko/struct.Session.html"><code class="language-plaintext highlighter-rouge">Session</code></a> and a <a href="https://docs.rs/makiko/latest/makiko/struct.SessionReceiver.html"><code class="language-plaintext highlighter-rouge">SessionReceiver</code></a>. This is the same pattern as with <a href="https://docs.rs/makiko/latest/makiko/struct.Client.html"><code class="language-plaintext highlighter-rouge">Client</code></a> and <a href="https://docs.rs/makiko/latest/makiko/struct.ClientReceiver.html"><code class="language-plaintext highlighter-rouge">ClientReceiver</code></a>: you use the <code class="language-plaintext highlighter-rouge">Session</code> object to invoke operations on the session, and the <code class="language-plaintext highlighter-rouge">SessionReceiver</code> object to receive events from the session.</p> <h2 id="handle-session-events"> <a href="#handle-session-events" class="anchor-heading" aria-labelledby="handle-session-events"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Handle session events </h2> <p>To handle events from the <a href="https://docs.rs/makiko/latest/makiko/struct.SessionReceiver.html"><code class="language-plaintext highlighter-rouge">SessionReceiver</code></a>, we will spawn another task, like we did with client events. To receive the events, we will use the method <a href="https://docs.rs/makiko/latest/makiko/struct.SessionReceiver.html#method.recv"><code class="language-plaintext highlighter-rouge">SessionReceiver::recv()</code></a>. The events are represented using the enum <a href="https://docs.rs/makiko/latest/makiko/enum.SessionEvent.html"><code class="language-plaintext highlighter-rouge">SessionEvent</code></a>. The <code class="language-plaintext highlighter-rouge">recv()</code> method returns <code class="language-plaintext highlighter-rouge">None</code> when the session is closed and no more events will be received:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">tokio</span><span class="p">::</span><span class="nn">task</span><span class="p">::</span><span class="nf">spawn</span><span class="p">(</span><span class="k">async</span> <span class="k">move</span> <span class="p">{</span>
    <span class="k">loop</span> <span class="p">{</span>
        <span class="c1">// Wait for the next event.</span>
        <span class="k">let</span> <span class="n">event</span> <span class="o">=</span> <span class="n">session_rx</span><span class="nf">.recv</span><span class="p">()</span><span class="k">.await</span>
            <span class="nf">.expect</span><span class="p">(</span><span class="s">"Error while receiving session event"</span><span class="p">);</span>

        <span class="c1">// Exit the loop when the session has closed.</span>
        <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">=</span> <span class="n">event</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">};</span>

        <span class="k">match</span> <span class="n">event</span> <span class="p">{</span>
            <span class="o">...</span> <span class="c1">// We will handle the event here</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div> <p class="warning">You have to receive the events from the <code class="language-plaintext highlighter-rouge">SessionReceiver</code> even if you don’t need to handle them (which should be rare). Makiko internally uses a channel to send events to the <code class="language-plaintext highlighter-rouge">SessionReceiver</code>, and if you don’t receive the events, this channel will become full and the client will block.</p> <h3 id="output-from-the-process"> <a href="#output-from-the-process" class="anchor-heading" aria-labelledby="output-from-the-process"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Output from the process </h3> <p>Output from the process is received as <code class="language-plaintext highlighter-rouge">StdoutData</code> and <code class="language-plaintext highlighter-rouge">StderrData</code> variants of <a href="https://docs.rs/makiko/latest/makiko/enum.SessionEvent.html"><code class="language-plaintext highlighter-rouge">SessionEvent</code></a>:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">match</span> <span class="n">event</span> <span class="p">{</span>
    <span class="c1">// Handle stdout/stderr output from the process.</span>
    <span class="nn">makiko</span><span class="p">::</span><span class="nn">SessionEvent</span><span class="p">::</span><span class="nf">StdoutData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"Process produced stdout: {:?}"</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nn">makiko</span><span class="p">::</span><span class="nn">SessionEvent</span><span class="p">::</span><span class="nf">StderrData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"Process produced stderr: {:?}"</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div> <p>The data is received as chunks of bytes, but the boundaries between the chunks are not meaningful, you should treat stdout and stderr as byte streams.</p> <h3 id="process-exit"> <a href="#process-exit" class="anchor-heading" aria-labelledby="process-exit"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Process exit </h3> <p>When the process exits, the SSH server sends an <code class="language-plaintext highlighter-rouge">ExitStatus</code> if the process exited with a status, or <code class="language-plaintext highlighter-rouge">ExitSignal</code> if it was killed by a signal:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">match</span> <span class="n">event</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">// Handle exit of the process.</span>
    <span class="nn">makiko</span><span class="p">::</span><span class="nn">SessionEvent</span><span class="p">::</span><span class="nf">ExitStatus</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"Process exited with status {}"</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nn">makiko</span><span class="p">::</span><span class="nn">SessionEvent</span><span class="p">::</span><span class="nf">ExitSignal</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"Process exited with signal {:?}: {:?}"</span><span class="p">,</span> <span class="n">signal</span><span class="py">.signal_name</span><span class="p">,</span> <span class="n">signal</span><span class="py">.message</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="other-events"> <a href="#other-events" class="anchor-heading" aria-labelledby="other-events"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Other events </h3> <p>The server may also send an <code class="language-plaintext highlighter-rouge">Eof</code> event after the process closes its stdout and stderr. We will ignore this event, together with any other events that might be introduced in future versions of the library:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">match</span> <span class="n">event</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">// Ignore other events</span>
    <span class="n">_</span> <span class="k">=&gt;</span> <span class="p">{},</span>
<span class="p">}</span>
</code></pre></div></div> <p>Note that the <a href="https://docs.rs/makiko/latest/makiko/enum.SessionEvent.html"><code class="language-plaintext highlighter-rouge">SessionEvent</code></a> enum is marked as <code class="language-plaintext highlighter-rouge">#[non_exhaustive]</code>, so the Rust compiler will require you to add the catch-all <code class="language-plaintext highlighter-rouge">match</code> clause even if you handle all variants of the enum. This allows us to add new kinds of events to Makiko without breaking your code.</p> <h2 id="execute-the-command"> <a href="#execute-the-command" class="anchor-heading" aria-labelledby="execute-the-command"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Execute the command </h2> <p>The session is now ready, so we can execute the command using <a href="https://docs.rs/makiko/latest/makiko/struct.Session.html#method.exec"><code class="language-plaintext highlighter-rouge">Session::exec()</code></a>. We will execute the command <code class="language-plaintext highlighter-rouge">sed s/blue/green/g</code>, which reads lines from the standard input, replaces <code class="language-plaintext highlighter-rouge">blue</code> with <code class="language-plaintext highlighter-rouge">green</code>, and prints the lines back to stdout:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Execute a command on the session</span>
<span class="n">session</span><span class="nf">.exec</span><span class="p">(</span><span class="s">"sed s/blue/green/"</span><span class="nf">.as_bytes</span><span class="p">())</span>
    <span class="nf">.expect</span><span class="p">(</span><span class="s">"Could not execute a command in the session"</span><span class="p">)</span>
    <span class="nf">.wait</span><span class="p">()</span><span class="k">.await</span>
    <span class="nf">.expect</span><span class="p">(</span><span class="s">"Server returned an error when we tried to execute a command in the session"</span><span class="p">);</span>

</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">exec()</code> method returns a <a href="https://docs.rs/makiko/latest/makiko/struct.SessionResp.html"><code class="language-plaintext highlighter-rouge">SessionResp</code></a>, which represents the server response to the execute request. We wait for the response using <a href="https://docs.rs/makiko/latest/makiko/struct.SessionResp.html#method.wait"><code class="language-plaintext highlighter-rouge">SessionResp::wait()</code></a>, but you can also ignore the response with <a href="https://docs.rs/makiko/latest/makiko/struct.SessionResp.html#method.ignore"><code class="language-plaintext highlighter-rouge">SessionResp::ignore()</code></a></p> <h2 id="send-data-to-the-process"> <a href="#send-data-to-the-process" class="anchor-heading" aria-labelledby="send-data-to-the-process"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Send data to the process </h2> <p>We will use the <a href="https://docs.rs/makiko/latest/makiko/struct.Session.html#method.send_stdin"><code class="language-plaintext highlighter-rouge">Session::send_stdin()</code></a> method to send data to the standard input of the running process, and <a href="https://docs.rs/makiko/latest/makiko/struct.Session.html#method.send_eof"><code class="language-plaintext highlighter-rouge">Session::send_eof()</code></a> to send end-of-file, which will close the standard input:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Send some data to the standard input of the process</span>
<span class="n">session</span><span class="nf">.send_stdin</span><span class="p">(</span><span class="s">"blueberry jam</span><span class="se">\n</span><span class="s">"</span><span class="nf">.into</span><span class="p">())</span><span class="k">.await</span><span class="nf">.unwrap</span><span class="p">();</span>
<span class="n">session</span><span class="nf">.send_stdin</span><span class="p">(</span><span class="s">"blue jeans</span><span class="se">\n</span><span class="s">sky blue"</span><span class="nf">.into</span><span class="p">())</span><span class="k">.await</span><span class="nf">.unwrap</span><span class="p">();</span>
<span class="n">session</span><span class="nf">.send_eof</span><span class="p">()</span><span class="k">.await</span><span class="nf">.unwrap</span><span class="p">();</span>
</code></pre></div></div> <h2 id="wait-for-the-session"> <a href="#wait-for-the-session" class="anchor-heading" aria-labelledby="wait-for-the-session"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Wait for the session </h2> <p>We have started the process and sent some data to it, and now we need to wait until the process terminates and the session is closed. Recall that when the session is closed, the <a href="https://docs.rs/makiko/latest/makiko/struct.SessionReceiver.html"><code class="language-plaintext highlighter-rouge">SessionReceiver</code></a> returns <code class="language-plaintext highlighter-rouge">None</code>, we break out of the event handling loop and the task terminates. We will change the code that we have written previously to store the <a href="https://docs.rs/tokio/latest/tokio/task/struct.JoinHandle.html"><code class="language-plaintext highlighter-rouge">JoinHandle</code></a> from the <code class="language-plaintext highlighter-rouge">spawn()</code> call:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">session_event_task</span> <span class="o">=</span> <span class="nn">tokio</span><span class="p">::</span><span class="nn">task</span><span class="p">::</span><span class="nf">spawn</span><span class="p">(</span><span class="k">async</span> <span class="k">move</span> <span class="p">{</span>
    <span class="k">loop</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">event</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div> <p>Back on the main task, we will wait for the event-handling task to terminate:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Wait for the task that handles session events</span>
<span class="n">session_event_task</span><span class="k">.await</span><span class="nf">.unwrap</span><span class="p">();</span>
</code></pre></div></div><hr /> <p>Full code for this tutorial can be found in <a href="https://github.com/honzasp/makiko/blob/master/examples/tutorial_5.rs"><code class="language-plaintext highlighter-rouge">examples/tutorial_5.rs</code></a>. If you don’t use the <a href="/makiko/tutorial/1-connect.html#example-server">example server for this tutorial</a>, you may need to change the code to use a different username and password.</p> <p> <a href="/makiko/tutorial/6-open-tunnel.html" class="btn btn-primary">Next: Open a tunnel</a> </p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
