<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/makiko/assets/css/just-the-docs-default.css"> <script src="/makiko/assets/js/vendor/lunr.min.js"></script> <script src="/makiko/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/makiko/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Connecting to the server | Makiko</title> <meta name="generator" content="Jekyll v4.3.0" /> <meta property="og:title" content="Connecting to the server" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Makiko is an asynchronous SSH client library in pure Rust" /> <meta property="og:description" content="Makiko is an asynchronous SSH client library in pure Rust" /> <link rel="canonical" href="https://honzasp.github.io/makiko/makiko/tutorial/1-connect.html" /> <meta property="og:url" content="https://honzasp.github.io/makiko/makiko/tutorial/1-connect.html" /> <meta property="og:site_name" content="Makiko" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Connecting to the server" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Makiko is an asynchronous SSH client library in pure Rust","headline":"Connecting to the server","url":"https://honzasp.github.io/makiko/makiko/tutorial/1-connect.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Feather. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/makiko/" class="site-title lh-tight"> Makiko </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/makiko/" class="nav-list-link">Home</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Tutorial category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/makiko/tutorial/" class="nav-list-link">Tutorial</a><ul class="nav-list "><li class="nav-list-item active"><a href="/makiko/tutorial/1-connect.html" class="nav-list-link active">Connecting to the server</a></li><li class="nav-list-item "><a href="/makiko/tutorial/2-password-auth.html" class="nav-list-link">Password authentication</a></li><li class="nav-list-item "><a href="/makiko/tutorial/3-pubkey-auth.html" class="nav-list-link">Public key authentication</a></li><li class="nav-list-item "><a href="/makiko/tutorial/4-pubkey-algo.html" class="nav-list-link">Public key algorithm</a></li><li class="nav-list-item "><a href="/makiko/tutorial/5-execute-command.html" class="nav-list-link">Execute a command</a></li><li class="nav-list-item "><a href="/makiko/tutorial/6-open-tunnel.html" class="nav-list-link">Open a tunnel</a></li><li class="nav-list-item "><a href="/makiko/tutorial/7-verify-pubkey.html" class="nav-list-link">Verify the server key</a></li></ul></li></ul> <ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/honzasp/makiko" class="nav-list-link external"> Makiko on Github <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li><li class="nav-list-item external"> <a href="https://docs.rs/makiko/latest/makiko" class="nav-list-link external"> API documentation <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Makiko" aria-label="Search Makiko" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/honzasp/makiko" class="site-button" > Github </a> </li> <li class="aux-nav-list-item"> <a href="https://docs.rs/makiko/latest/makiko" class="site-button" > API docs </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/makiko/tutorial/">Tutorial</a></li> <li class="breadcrumb-nav-list-item"><span>Connecting to the server</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="connecting-to-the-server"> <a href="#connecting-to-the-server" class="anchor-heading" aria-labelledby="connecting-to-the-server"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Connecting to the server </h1> <p>In this chapter, we will connect to an SSH server and print out the server public key.</p> <h2 id="example-server"> <a href="#example-server" class="anchor-heading" aria-labelledby="example-server"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> An example server </h2> <p>To test an SSH client, we need an SSH server! If you have Docker installed, you can run <a href="https://hub.docker.com/repository/docker/honzasp/makiko-tutorial/general">my example SSH server</a> in a Docker container as follows:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run --rm -p 2222:22 --name example-ssh-server honzasp/makiko-tutorial
</code></pre></div></div> <p>This command will start the container in the background and it will bind the server to port 2222 on your localhost. You can connect to this server with username <code class="language-plaintext highlighter-rouge">alice</code> and password <code class="language-plaintext highlighter-rouge">alicealice</code>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ssh -p 2222 alice@localhost
</code></pre></div></div> <p>To stop the container, you can run:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker stop example-ssh-server
</code></pre></div></div> <p>If using Docker is not convenient for you, you can follow the tutorial by connecting to another SSH server that you can access, but you will need to adjust the connection details in the code.</p> <h2 id="open-the-connection"> <a href="#open-the-connection" class="anchor-heading" aria-labelledby="open-the-connection"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Open the connection </h2> <p>We will put all our code in <code class="language-plaintext highlighter-rouge">src/main.rs</code>. Makiko uses Tokio and async, so our main function looks as follows:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[tokio::main]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span> <span class="c1">// Our code will go here</span>
<span class="p">}</span>
</code></pre></div></div> <p>We use the <a href="https://docs.rs/tokio/latest/tokio/attr.main.html"><code class="language-plaintext highlighter-rouge">#[tokio::main]</code></a> attribute to conveniently initialize the Tokio runtime and enable async code in <code class="language-plaintext highlighter-rouge">main()</code>.</p> <p class="note">You may wonder why we don’t return a <code class="language-plaintext highlighter-rouge">Result</code> from <code class="language-plaintext highlighter-rouge">main()</code>. To keep things simple in the tutorial, we will panic when we encounter an error. In real code, you should <a href="https://doc.rust-lang.org/book/ch09-00-error-handling.html">handle errors properly</a>.</p> <h3 id="the-socket"> <a href="#the-socket" class="anchor-heading" aria-labelledby="the-socket"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The socket </h3> <p>First, we need to open a TCP socket to the SSH server. Makiko can work with anything that implements <a href="https://docs.rs/tokio/latest/tokio/io/trait.AsyncRead.html"><code class="language-plaintext highlighter-rouge">AsyncRead</code></a> and <a href="https://docs.rs/tokio/latest/tokio/io/trait.AsyncWrite.html"><code class="language-plaintext highlighter-rouge">AsyncWrite</code></a>, so you can also use Unix domain sockets, pipes or other exotic modes of transport. However, a <a href="https://docs.rs/tokio/latest/tokio/net/struct.TcpStream.html"><code class="language-plaintext highlighter-rouge">tokio::net::TcpStream</code></a> will be the most usual choice:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">socket</span> <span class="o">=</span> <span class="nn">tokio</span><span class="p">::</span><span class="nn">net</span><span class="p">::</span><span class="nn">TcpStream</span><span class="p">::</span><span class="nf">connect</span><span class="p">((</span><span class="s">"localhost"</span><span class="p">,</span> <span class="mi">2222</span><span class="p">))</span><span class="k">.await</span>
    <span class="nf">.expect</span><span class="p">(</span><span class="s">"Could not open a TCP socket"</span><span class="p">);</span>
</code></pre></div></div> <h3 id="configuration"> <a href="#configuration" class="anchor-heading" aria-labelledby="configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuration </h3> <p>The SSH protocol supports many cryptographic algorithms for different aspects of the connection, such as key exchange or encryption. We need to configure the client using the <a href="https://docs.rs/makiko/latest/makiko/struct.ClientConfig.html"><code class="language-plaintext highlighter-rouge">makiko::ClientConfig</code></a> struct, which specifies the algorithms that the client can use and other low-level details. In most cases, you can use the default configuration, which uses only very secure cryptography:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Recommended configuration that uses only the best crypto</span>
<span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">makiko</span><span class="p">::</span><span class="nn">ClientConfig</span><span class="p">::</span><span class="nf">default</span><span class="p">();</span>
</code></pre></div></div> <p>However, if you need to connect to older SSH servers that don’t support the newest crypto, you can use configuration that allows all algorithms implemented in Makiko. None of these algorithms are known to be <em>broken</em>, but they use primitives with known weaknesses (such as HMAC with SHA-1), are considered suspicious (NIST elliptic curves) or have suboptimal implementation in Makiko (Diffie-Hellman key exchange).</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Less secure configuration compatible with almost all SSH servers</span>
<span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">makiko</span><span class="p">::</span><span class="nn">ClientConfig</span><span class="p">::</span><span class="nf">default_compatible_less_secure</span><span class="p">();</span>
</code></pre></div></div> <p>If you want more fine-grained configuration, please <a href="https://docs.rs/makiko/latest/makiko/struct.ClientConfig.html">see the documentation</a>.</p> <h3 id="the-client"> <a href="#the-client" class="anchor-heading" aria-labelledby="the-client"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The client </h3> <p>We now have all that is needed to open the <a href="https://docs.rs/makiko/latest/makiko/struct.Client.html"><code class="language-plaintext highlighter-rouge">makiko::Client</code></a>:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="k">mut</span> <span class="n">client_rx</span><span class="p">,</span> <span class="n">client_fut</span><span class="p">)</span> <span class="o">=</span> <span class="nn">makiko</span><span class="p">::</span><span class="nn">Client</span><span class="p">::</span><span class="nf">open</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="nf">.expect</span><span class="p">(</span><span class="s">"Could not open client"</span><span class="p">);</span>
</code></pre></div></div> <p>The <a href="https://docs.rs/makiko/latest/makiko/struct.Client.html#method.open"><code class="language-plaintext highlighter-rouge">Client::open()</code></a> associated function returns three objects: a <a href="https://docs.rs/makiko/latest/makiko/struct.Client.html"><code class="language-plaintext highlighter-rouge">Client</code></a>, a <a href="https://docs.rs/makiko/latest/makiko/struct.ClientReceiver.html"><code class="language-plaintext highlighter-rouge">ClientReceiver</code></a> and a <a href="https://docs.rs/makiko/latest/makiko/struct.ClientFuture.html"><code class="language-plaintext highlighter-rouge">ClientFuture</code></a>.</p> <p>In the next sections, we will deal with the <code class="language-plaintext highlighter-rouge">ClientReceiver</code> and <code class="language-plaintext highlighter-rouge">ClientFuture</code>, and the following chapters will make use of the <code class="language-plaintext highlighter-rouge">Client</code>.</p> <h2 id="polling-the-client"> <a href="#polling-the-client" class="anchor-heading" aria-labelledby="polling-the-client"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Polling the client </h2> <p>To handle the SSH connection, we need to asynchronously run the code that performs I/O on the underlying socket. This code is encapsulated in the <a href="https://docs.rs/makiko/latest/makiko/struct.ClientFuture.html"><code class="language-plaintext highlighter-rouge">ClientFuture</code></a>, which is a Rust <a href="https://doc.rust-lang.org/std/future/trait.Future.html"><code class="language-plaintext highlighter-rouge">Future</code></a> that you need to poll to drive the connection forward. The future is resolved when the client is closed or when the connection fails with an error.</p> <p>In this tutorial, we will simply spawn a Tokio task to poll the future in the background and panic when the connection fails:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">tokio</span><span class="p">::</span><span class="nn">task</span><span class="p">::</span><span class="nf">spawn</span><span class="p">(</span><span class="k">async</span> <span class="k">move</span> <span class="p">{</span>
    <span class="n">client_fut</span><span class="k">.await</span><span class="nf">.expect</span><span class="p">(</span><span class="s">"Error in client future"</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div> <p class="note">When we drop the <a href="https://docs.rs/tokio/latest/tokio/task/struct.JoinHandle.html"><code class="language-plaintext highlighter-rouge">JoinHandle</code></a> returned from <a href="https://docs.rs/tokio/latest/tokio/task/fn.spawn.html"><code class="language-plaintext highlighter-rouge">spawn()</code></a>, Tokio will detach the task and run it in the background. This works well in our tutorial, but in practice, <a href="https://vorpus.org/blog/notes-on-structured-concurrency-or-go-statement-considered-harmful/">it is usually better to follow the principles of structured concurrency</a> and always <code class="language-plaintext highlighter-rouge">.await</code> all tasks that you spawn. This will make sure that errors are always handled correctly, resources are cleaned up, and your program becomes easier to reason about.</p> <h2 id="handle-client-events"> <a href="#handle-client-events" class="anchor-heading" aria-labelledby="handle-client-events"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Handle client events </h2> <p>During the lifetime of the SSH connection, the client will asynchronously produce various events. To handle these events, we will use the <a href="https://docs.rs/makiko/latest/makiko/struct.ClientReceiver.html"><code class="language-plaintext highlighter-rouge">ClientReceiver</code></a>. This is a bit similar to channels in Tokio: Makiko sends events to this “channel”, and you receive them using <a href="https://docs.rs/makiko/latest/makiko/struct.ClientReceiver.html#method.recv"><code class="language-plaintext highlighter-rouge">ClientReceiver::recv()</code></a>, which is like the <a href="https://docs.rs/tokio/latest/tokio/sync/mpsc/struct.Receiver.html#method.recv"><code class="language-plaintext highlighter-rouge">Receiver::recv()</code></a> method of a Tokio channel:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">loop</span> <span class="p">{</span>
    <span class="c1">// Wait for the next event.</span>
    <span class="k">let</span> <span class="n">event</span> <span class="o">=</span> <span class="n">client_rx</span><span class="nf">.recv</span><span class="p">()</span><span class="k">.await</span>
        <span class="nf">.expect</span><span class="p">(</span><span class="s">"Error while receiving client event"</span><span class="p">);</span>

    <span class="c1">// Exit the loop when the client has closed.</span>
    <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">=</span> <span class="n">event</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">break</span>
    <span class="p">};</span>

    <span class="k">match</span> <span class="n">event</span> <span class="p">{</span>
        <span class="o">...</span> <span class="c1">// We will handle the event here</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="server-public-key"> <a href="#server-public-key" class="anchor-heading" aria-labelledby="server-public-key"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Server public key </h3> <p>The produced events are variants of the enum <a href="https://docs.rs/makiko/latest/makiko/enum.ClientEvent.html"><code class="language-plaintext highlighter-rouge">ClientEvent</code></a>. The most important variant that you always need to handle is <a href="https://docs.rs/makiko/latest/makiko/enum.ClientEvent.html#variant.ServerPubkey"><code class="language-plaintext highlighter-rouge">ClientEvent::ServerPubkey</code></a>, which you will get when Makiko receives the server’s public key during key exchange. This always happens when the connection is initialized, but you may also get this event after the connection is established if the connection is “rekeyed” to derive fresh encryption secrets.</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">match</span> <span class="n">event</span> <span class="p">{</span>
    <span class="c1">// Handle the server public key</span>
    <span class="nn">makiko</span><span class="p">::</span><span class="nn">ClientEvent</span><span class="p">::</span><span class="nf">ServerPubkey</span><span class="p">(</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">accept</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="o">...</span> <span class="c1">// Verify the server public key here</span>
    <span class="p">},</span>

    <span class="o">...</span> <span class="c1">// Handle other events here</span>
<span class="p">}</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">ServerPubkey</code> variant has two fields: the server <a href="https://docs.rs/makiko/latest/makiko/pubkey/enum.Pubkey.html"><code class="language-plaintext highlighter-rouge">Pubkey</code></a> and an <a href="https://docs.rs/makiko/latest/makiko/struct.AcceptPubkey.html"><code class="language-plaintext highlighter-rouge">AcceptPubkey</code></a> object that we will use to tell Makiko whether we accept or reject the key.</p> <p>To prevent <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle attacks</a>, it is very important to verify that this public key belongs to the server that we wanted to connect to. Unfortunately, SSH does not provide any mechanism to verify identity of the server (in contrast to TLS, which is used in HTTPS to secure the Web and which provides certificate-based public key infrastructure). This means that it is up to you whether to accept or reject the public key.</p> <p><a href="/makiko/tutorial/7-verify-pubkey.html">Later in the tutorial</a>, we will learn how to implement a <a href="https://en.wikipedia.org/wiki/Trust_on_first_use">trust on first use (TOFU)</a> scheme using the standard <code class="language-plaintext highlighter-rouge">~/.ssh/known_hosts</code> file. But for now, we won’t do any verification and we will accept any key:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">match</span> <span class="n">event</span> <span class="p">{</span>
    <span class="c1">// Handle the server public key: for now, we just accept all keys, but this makes</span>
    <span class="c1">// us susceptible to man-in-the-middle attacks!</span>
    <span class="nn">makiko</span><span class="p">::</span><span class="nn">ClientEvent</span><span class="p">::</span><span class="nf">ServerPubkey</span><span class="p">(</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">accept</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"Server pubkey type {}, fingerprint {}"</span><span class="p">,</span> <span class="n">pubkey</span><span class="nf">.type_str</span><span class="p">(),</span> <span class="n">pubkey</span><span class="nf">.fingerprint</span><span class="p">());</span>
        <span class="n">accept</span><span class="nf">.accept</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div> <p class="warning">If you don’t verify the server public key, <a href="https://blog.rust-lang.org/2023/01/10/cve-2022-46176.html">it might be treated as a security vulnerability</a>.</p> <h3 id="other-events"> <a href="#other-events" class="anchor-heading" aria-labelledby="other-events"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Other events </h3> <p>You can <a href="https://docs.rs/makiko/latest/makiko/enum.ClientEvent.html">read the documentation</a> if you want to learn about other client events, but we won’t need to handle them in this tutorial, so we can just ignore them:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">match</span> <span class="n">event</span> <span class="p">{</span>
    <span class="o">...</span>

    <span class="c1">// All other events can be safely ignored</span>
    <span class="n">_</span> <span class="k">=&gt;</span> <span class="p">{},</span>
<span class="p">}</span>
</code></pre></div></div><hr /> <p>You can find the full code for this tutorial in <a href="https://github.com/honzasp/makiko/blob/master/examples/tutorial_1.rs"><code class="language-plaintext highlighter-rouge">examples/tutorial_1.rs</code></a>. If all works well, the program prints the fingerprint of the server public key and hangs. In the next chapter, we will continue by authenticating to the server using a password.</p> <p> <a href="/makiko/tutorial/2-password-auth.html" class="btn btn-primary">Next: Password authentication</a> </p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
