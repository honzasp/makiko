<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/makiko/assets/css/just-the-docs-default.css"> <script src="/makiko/assets/js/vendor/lunr.min.js"></script> <script src="/makiko/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/makiko/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Verify the server key | Makiko</title> <meta name="generator" content="Jekyll v4.3.0" /> <meta property="og:title" content="Verify the server key" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Makiko is an asynchronous SSH client library in pure Rust" /> <meta property="og:description" content="Makiko is an asynchronous SSH client library in pure Rust" /> <link rel="canonical" href="https://honzasp.github.io/makiko/makiko/tutorial/7-verify-pubkey.html" /> <meta property="og:url" content="https://honzasp.github.io/makiko/makiko/tutorial/7-verify-pubkey.html" /> <meta property="og:site_name" content="Makiko" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Verify the server key" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Makiko is an asynchronous SSH client library in pure Rust","headline":"Verify the server key","url":"https://honzasp.github.io/makiko/makiko/tutorial/7-verify-pubkey.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Feather. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/makiko/" class="site-title lh-tight"> Makiko </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/makiko/" class="nav-list-link">Home</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Tutorial category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/makiko/tutorial/" class="nav-list-link">Tutorial</a><ul class="nav-list "><li class="nav-list-item "><a href="/makiko/tutorial/1-connect.html" class="nav-list-link">Connecting to the server</a></li><li class="nav-list-item "><a href="/makiko/tutorial/2-password-auth.html" class="nav-list-link">Password authentication</a></li><li class="nav-list-item "><a href="/makiko/tutorial/3-pubkey-auth.html" class="nav-list-link">Public key authentication</a></li><li class="nav-list-item "><a href="/makiko/tutorial/4-pubkey-algo.html" class="nav-list-link">Public key algorithm</a></li><li class="nav-list-item "><a href="/makiko/tutorial/5-execute-command.html" class="nav-list-link">Execute a command</a></li><li class="nav-list-item "><a href="/makiko/tutorial/6-open-tunnel.html" class="nav-list-link">Open a tunnel</a></li><li class="nav-list-item active"><a href="/makiko/tutorial/7-verify-pubkey.html" class="nav-list-link active">Verify the server key</a></li></ul></li></ul> <ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/honzasp/makiko" class="nav-list-link external"> Makiko on Github <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li><li class="nav-list-item external"> <a href="https://docs.rs/makiko/latest/makiko" class="nav-list-link external"> API documentation <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Makiko" aria-label="Search Makiko" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/honzasp/makiko" class="site-button" > Github </a> </li> <li class="aux-nav-list-item"> <a href="https://docs.rs/makiko/latest/makiko" class="site-button" > API docs </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/makiko/tutorial/">Tutorial</a></li> <li class="breadcrumb-nav-list-item"><span>Verify the server key</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="verify-the-server-key"> <a href="#verify-the-server-key" class="anchor-heading" aria-labelledby="verify-the-server-key"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Verify the server key </h1> <p><a href="/makiko/tutorial/1-connect.html#server-public-key">Back in chapter 1</a>, we said that we should verify the public key presented by the server during the initial connection handshake (or during any follow-up key exchange). The SSH protocol does not contain any mechanism for verifying the server key, so you must do it yourself using a method that suits your application.</p> <p>For example, you can check that the key provided by the server belongs to an allowed set of keys configured with the client. For some applications, not verifying the key may also be a valid approach, but please make sure that you understand the implications. Reading <a href="https://www.rfc-editor.org/rfc/rfc4251#section-9.3.4">about man-in-the-middle attacks</a> in the SSH protocol architecture RFC might be a good start.</p> <p class="note">The SSH protocol does not verify the public key (it does not check that it belongs to the server that you wanted to connect to), but it <strong>does</strong> verify that the server owns the corresponding private key.</p> <h2 id="trust-on-first-use"> <a href="#trust-on-first-use" class="anchor-heading" aria-labelledby="trust-on-first-use"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Trust on first use </h2> <p>In this chapter, we will show how you can implement the <a href="https://en.wikipedia.org/wiki/Trust_on_first_use">trust-on-first-use (TOFU)</a> approach for verifying public keys using the well-known <a href="https://man.openbsd.org/sshd.8#SSH_KNOWN_HOSTS_FILE_FORMAT"><code class="language-plaintext highlighter-rouge">~/.ssh/known_hosts</code></a> file.</p> <p>With this approach, when we connect to a server, we look up its address in the <code class="language-plaintext highlighter-rouge">known_hosts</code> file. If no entry in this file matches the address, it means that we are connecting to the server for the first time, so we accept the server key unconditionally (“trust on first use”) and add an entry to the file.</p> <p>On the other hand, if the file contains at least one entry that matches the address, we check that the key provided by the server is equal to the key from one of the matched entries. If the key fails this check, it means that the server key has changed from the last time that we connected to the server, which may mean that somebody is attempting a man-in-the-middle attack, so we reject the key, which aborts the connection. (This is the <em>“IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!”</em> error that you may have encountered when using the <code class="language-plaintext highlighter-rouge">ssh</code> client from OpenSSH.)</p> <p class="note">It is important to use the hostname of the SSH server as specified by the user when searching for entries in the <code class="language-plaintext highlighter-rouge">known_hosts</code> file. For example, if the user specifies a domain name, we must look up the domain name and not the resolved IP address, because an attacker can modify the DNS record of the server to point to a different IP address.</p> <p>In the rest of this chapter, we will be writing code that handles the <a href="https://docs.rs/makiko/latest/makiko/enum.ClientEvent.html#variant.ServerPubkey"><code class="language-plaintext highlighter-rouge">ClientEvent::ServerPubkey</code></a> event:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">match</span> <span class="n">event</span> <span class="p">{</span>
    <span class="nn">makiko</span><span class="p">::</span><span class="nn">ClientEvent</span><span class="p">::</span><span class="nf">ServerPubkey</span><span class="p">(</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">accept</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"Server pubkey type {}, fingerprint {}"</span><span class="p">,</span> <span class="n">pubkey</span><span class="nf">.type_str</span><span class="p">(),</span> <span class="n">pubkey</span><span class="nf">.fingerprint</span><span class="p">());</span>

        <span class="o">...</span> <span class="c1">// Verify the `pubkey` and call `accept.accept()` if it is valid</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div> <h2 id="read-the-known_hosts-file"> <a href="#read-the-known_hosts-file" class="anchor-heading" aria-labelledby="read-the-known_hosts-file"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Read the <code class="language-plaintext highlighter-rouge">known_hosts</code> file </h2> <p>Makiko provides support for reading a <code class="language-plaintext highlighter-rouge">known_hosts</code> file using features from the <a href="https://docs.rs/makiko/latest/makiko/host_file/index.html"><code class="language-plaintext highlighter-rouge">host_file</code> module</a>. Makiko can read the file, but it can also append new entries to the file and losslessly write the updated file back.</p> <p>We start by locating the file and reading its contents into memory:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Read the ~/.ssh/known_hosts file.</span>
<span class="k">let</span> <span class="n">hosts_path</span> <span class="o">=</span> <span class="nn">home</span><span class="p">::</span><span class="nf">home_dir</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span><span class="nf">.join</span><span class="p">(</span><span class="s">".ssh/known_hosts"</span><span class="p">);</span>
<span class="k">let</span> <span class="n">hosts_data</span> <span class="o">=</span> <span class="nn">std</span><span class="p">::</span><span class="nn">fs</span><span class="p">::</span><span class="nf">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hosts_path</span><span class="p">)</span>
    <span class="nf">.expect</span><span class="p">(</span><span class="s">"Could not read known_hosts file"</span><span class="p">);</span>
</code></pre></div></div> <p>We have used the <a href="https://docs.rs/home/latest/home/"><code class="language-plaintext highlighter-rouge">home</code></a> crate to reliably find the user’s home directory, so you may need to add it to your <code class="language-plaintext highlighter-rouge">Cargo.toml</code>:</p> <div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[dependencies]</span>
<span class="py">home</span> <span class="p">=</span> <span class="s">"0.5"</span>
</code></pre></div></div> <p>We can now use the <a href="https://docs.rs/makiko/latest/makiko/host_file/struct.File.html#method.decode"><code class="language-plaintext highlighter-rouge">host_file::File::decode()</code></a> method to parse the file and get a <a href="https://docs.rs/makiko/latest/makiko/host_file/struct.File.html"><code class="language-plaintext highlighter-rouge">host_file::File</code></a>. Note that this method does not return a <code class="language-plaintext highlighter-rouge">Result</code>: when it encounters invalid or unrecognized lines, it simply ignores them (but keeps them around, so that we can later losslessly encode the file back).</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Decode the contents of the file.</span>
<span class="k">let</span> <span class="k">mut</span> <span class="n">hosts_file</span> <span class="o">=</span> <span class="nn">makiko</span><span class="p">::</span><span class="nn">host_file</span><span class="p">::</span><span class="nn">File</span><span class="p">::</span><span class="nf">decode</span><span class="p">(</span><span class="n">hosts_data</span><span class="nf">.into</span><span class="p">());</span>
</code></pre></div></div> <h2 id="lookup-the-server-address"> <a href="#lookup-the-server-address" class="anchor-heading" aria-labelledby="lookup-the-server-address"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Lookup the server address </h2> <p>The <code class="language-plaintext highlighter-rouge">known_hosts</code> file is a sequence of entries (<a href="https://docs.rs/makiko/latest/makiko/host_file/struct.Entry.html"><code class="language-plaintext highlighter-rouge">host_file::Entry</code></a>). Every entry stores a single public key and it contains a pattern that can match an address.</p> <p>The pattern might be a concrete hostname (such as <code class="language-plaintext highlighter-rouge">github.com</code>, <code class="language-plaintext highlighter-rouge">140.82.121.4</code> or <code class="language-plaintext highlighter-rouge">[localhost]:2222</code>), a wildcard pattern (such as <code class="language-plaintext highlighter-rouge">*.github.com</code> or <code class="language-plaintext highlighter-rouge">g?thub.com</code>) or a hash of the hostname (<code class="language-plaintext highlighter-rouge">|1|4n/lI1Js...my6Q=</code>). The hashed pattern is usually preferred, because it hides the identity of SSH servers that you have connected to, in case your <code class="language-plaintext highlighter-rouge">known_hosts</code> file is leaked.</p> <p>Some entires may also be marked as revoked, which means that the public key should be rejected instead of accepted.</p> <p>We can use the method <a href="https://docs.rs/makiko/latest/makiko/host_file/struct.File.html#method.match_host_port_key"><code class="language-plaintext highlighter-rouge">host_file::File::match_host_port_key()</code></a> to search for all entries that match the given host and port. The result of this search is a <a href="https://docs.rs/makiko/latest/makiko/host_file/enum.KeyMatch.html"><code class="language-plaintext highlighter-rouge">host_file::KeyMatch</code></a>:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Lookup the server address in the file.</span>
<span class="k">let</span> <span class="n">key_match</span> <span class="o">=</span> <span class="n">hosts_file</span><span class="nf">.match_host_port_key</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pubkey</span><span class="p">);</span>
</code></pre></div></div> <h2 id="deal-with-the-result-of-the-lookup"> <a href="#deal-with-the-result-of-the-lookup" class="anchor-heading" aria-labelledby="deal-with-the-result-of-the-lookup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Deal with the result of the lookup </h2> <p>There are four variants of the <a href="https://docs.rs/makiko/latest/makiko/host_file/enum.KeyMatch.html"><code class="language-plaintext highlighter-rouge">host_file::KeyMatch</code></a> enum, so we need to handle them all:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">match</span> <span class="n">key_match</span> <span class="p">{</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="key-is-present-in-the-file"> <a href="#key-is-present-in-the-file" class="anchor-heading" aria-labelledby="key-is-present-in-the-file"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Key is present in the file </h3> <p>The <code class="language-plaintext highlighter-rouge">Accepted</code> variant means that the <code class="language-plaintext highlighter-rouge">known_hosts</code> file contains at least one entry that matches the hostname and which refers to the public key provided by the server. This means that we have previously decided to trust this key for this hostname, so we can call <a href="https://docs.rs/makiko/latest/makiko/struct.AcceptPubkey.html#method.accept"><code class="language-plaintext highlighter-rouge">AcceptPubkey::accept()</code></a> to accept the key:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">match</span> <span class="n">key_match</span> <span class="p">{</span>
    <span class="c1">// The given key was found in the file, this means that it is trusted and we</span>
    <span class="c1">// can accept it.</span>
    <span class="nn">makiko</span><span class="p">::</span><span class="nn">host_file</span><span class="p">::</span><span class="nn">KeyMatch</span><span class="p">::</span><span class="nf">Accepted</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"Found the server key in known_hosts file"</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">entries</span><span class="nf">.iter</span><span class="p">()</span> <span class="p">{</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"At line {}"</span><span class="p">,</span> <span class="n">entry</span><span class="nf">.line</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="n">accept</span><span class="nf">.accept</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="key-was-revoked"> <a href="#key-was-revoked" class="anchor-heading" aria-labelledby="key-was-revoked"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Key was revoked </h3> <p>The <code class="language-plaintext highlighter-rouge">Revoked</code> variant means that there was an entry that lists the key as revoked for the hostname, so we must reject the key. You can call <a href="https://docs.rs/makiko/latest/makiko/struct.AcceptPubkey.html#method.reject"><code class="language-plaintext highlighter-rouge">AcceptPubkey::reject()</code></a> with a custom error that describes the reason for the rejection, or you can simply drop the <code class="language-plaintext highlighter-rouge">AcceptPubkey</code> object, which will reject the key with a default error:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">match</span> <span class="n">key_match</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">// The key was revoked in the file, so we must reject it.</span>
    <span class="nn">makiko</span><span class="p">::</span><span class="nn">host_file</span><span class="p">::</span><span class="nn">KeyMatch</span><span class="p">::</span><span class="nf">Revoked</span><span class="p">(</span><span class="n">_entry</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"The server key was revoked in known_hosts file"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="other-keys-found-in-the-file"> <a href="#other-keys-found-in-the-file" class="anchor-heading" aria-labelledby="other-keys-found-in-the-file"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Other keys found in the file </h3> <p>The <code class="language-plaintext highlighter-rouge">OtherKeys</code> variant means that we found entries that match the hostname, but all of them specified a different public key. This means that we already know the valid keys of this server, but the server provided a different key, so we must reject the key, because a man-in-the-middle attack might be going on:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">match</span> <span class="n">key_match</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">// We found other keys for this server in the file, so the server changed its</span>
    <span class="c1">// key, or somebody is doing a man-in-the-middle attack on us.</span>
    <span class="nn">makiko</span><span class="p">::</span><span class="nn">host_file</span><span class="p">::</span><span class="nn">KeyMatch</span><span class="p">::</span><span class="nf">OtherKeys</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"The known_hosts file specifies other keys for this server:"</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">entries</span><span class="nf">.iter</span><span class="p">()</span> <span class="p">{</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"At line {}, pubkey type {}, fingerprint {}"</span><span class="p">,</span>
                <span class="n">entry</span><span class="nf">.line</span><span class="p">(),</span> <span class="n">entry</span><span class="nf">.pubkey</span><span class="p">()</span><span class="nf">.type_str</span><span class="p">(),</span> <span class="n">entry</span><span class="nf">.pubkey</span><span class="p">()</span><span class="nf">.fingerprint</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"Aborting, you might be target of a man-in-the-middle attack!"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="no-entry-was-found"> <a href="#no-entry-was-found" class="anchor-heading" aria-labelledby="no-entry-was-found"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> No entry was found </h3> <p>Finally, the <code class="language-plaintext highlighter-rouge">NotFound</code> variant means that the file does not contain any entry matching the given hostname. In this case, we may decide to trust the key and add it to the <code class="language-plaintext highlighter-rouge">known_hosts</code> file:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">match</span> <span class="n">key_match</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">// We did not find the key in the file, so we decide to accept the key and add</span>
    <span class="c1">// it to the file.</span>
    <span class="nn">makiko</span><span class="p">::</span><span class="nn">host_file</span><span class="p">::</span><span class="nn">KeyMatch</span><span class="p">::</span><span class="n">NotFound</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"Did not find any key for this server in known_hosts file, </span><span class="err">\</span><span class="s">
            adding it to the file"</span><span class="p">);</span>
        <span class="n">accept</span><span class="nf">.accept</span><span class="p">();</span>

        <span class="o">...</span> <span class="c1">// Add an entry to the file</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div> <p>To add an entry to the <a href="https://docs.rs/makiko/latest/makiko/host_file/struct.File.html"><code class="language-plaintext highlighter-rouge">host_file::File</code></a>, we can use the <a href="https://docs.rs/makiko/latest/makiko/host_file/struct.File.html#method.append_entry"><code class="language-plaintext highlighter-rouge">host_file::File::append_entry()</code></a> method and the <a href="https://docs.rs/makiko/latest/makiko/host_file/struct.EntryBuilder.html"><code class="language-plaintext highlighter-rouge">host_file::EntryBuilder</code></a>:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Append an entry with the key to the file.</span>
<span class="n">hosts_file</span><span class="nf">.append_entry</span><span class="p">(</span>
    <span class="nn">makiko</span><span class="p">::</span><span class="nn">host_file</span><span class="p">::</span><span class="nn">File</span><span class="p">::</span><span class="nf">entry_builder</span><span class="p">()</span>
        <span class="nf">.host_port</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="nf">.key</span><span class="p">(</span><span class="n">pubkey</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div> <p>To save the updated file to disk, we will use the <a href="https://docs.rs/makiko/latest/makiko/host_file/struct.File.html#method.encode"><code class="language-plaintext highlighter-rouge">host_file::File::encode()</code></a> method to get the modified contents of the file:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Write the modified file back to disk.</span>
<span class="k">let</span> <span class="n">hosts_data</span> <span class="o">=</span> <span class="n">hosts_file</span><span class="nf">.encode</span><span class="p">();</span>
<span class="nn">std</span><span class="p">::</span><span class="nn">fs</span><span class="p">::</span><span class="nf">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hosts_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hosts_data</span><span class="p">)</span>
    <span class="nf">.expect</span><span class="p">(</span><span class="s">"Could not write the modified known_hosts file"</span><span class="p">);</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">encode()</code> method is lossless: it faithfully preserves all existing lines, including comments or invalid lines.</p><hr /> <p>Full code for this tutorial can be found in <a href="https://github.com/honzasp/makiko/blob/master/examples/tutorial_7.rs"><code class="language-plaintext highlighter-rouge">examples/tutorial_7.rs</code></a>. If you don’t use the <a href="/makiko/tutorial/1-connect.html#example-server">example server for this tutorial</a>, you may need to change the code to use a different username and password.</p> <p>This concludes the Makiko tutorial. Thank you for your interest, I hope that the library will be useful to you and that you will enjoy using it!</p> <p> <a href="https://docs.rs/makiko/latest/makiko" class="btn btn-purple">Next: API documentation</a> </p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
